## This repository includes a set of scripts and functions that produce county-level aggregate outputs of HMDA application and origination activity.

#### File Descriptions:
aggregation.py: Aggregates data from HMDA LAR SQL tables, writes county-level aggregates to a holding folder, and creates annual county-level aggregate tables in PostgreSQL. This process takes approximately 2 hours to run. Requires HMDA LAR tables loaded for the years to be aggregated.

[split_by_county.py](https://github.com/Kibrael/county_level/blob/master/split_by_county.py): Merges the county-level aggregated data from application and origination PostgreSQL tables and writes a data.csv file for each valid FIPS county code using the path structure data/FIPS state/FIPS county/data.csv. This process takes approximately 15 minutes to run. Requires the output tables generated by aggregation.py

[load_agg_tables.py](https://github.com/Kibrael/county_level/blob/master/load_agg_tables.py): Drops, creates, and loads data to annual tables for county-level application and origination data. This process takes less than 5 minutes to run. Requires the CSV files generated by aggregation.py at data/holding/originations and data/holding/applicaitons

agg_funcs.py: Holds variables and functions for working with dataframes across multple aggregation scripts.

sql_text.py: Returns SQL statements formatted with passed variables.

#### Dependancies
[PostgreSQL](https://www.postgresql.org) with [HMDA LAR data](https://catalog.archives.gov/search?q=*:*&f.parentNaId=2456161&f.level=fileUnit&sort=naIdSort%20asc) loaded,
For code to load HMDA data please go to [this repository](https://github.com/Kibrael/HMDA_load)
[Psycopg2](http://www.psycopg.org/psycopg/)
[Python 3.5](https://www.python.org) or higher
[Pandas](http://pandas.pydata.org)
[Jupyter](http://jupyter.org) (for notebooks)
[Bokeh](http://bokeh.pydata.org/en/latest/) (for visualization)


Running the Aggregation(link) script will produce SQL tables and CSVs with the following fields:
Applications Table: (transactions where action != 1)
- year: The year of the data collection
- state: FIPS state code for the transaction
- county: FIPS county code for the transaction
- FIPS: FIPS county code for the transaction #FIXME this is a duplicate
- loan_average_app: The average value of all applications for the county, in thousands
- income_average_app: The average income of all applications for the county, in thousands
- count_app: The count of all applications in the county
- value_app: The dollar value of all applications in the county, in thousands
- Note: these fields are present as an aggregate of all races and each race listed in the HMDA filings.

Originations Table: (transactions where action = 1)
- year: The year of data collection
- state: FIPS state code for the transaction
- county: FIPS county code for the transaction
- FIPS: FIPS county code for the transaction #FIXME this is a duplicate
- loan_average_orig: The average value of all originations for the county, in thousands
- income_average_orig: The average income of all originations for the county, in thousands
- count_orig: The count of all originations in the county
- value_orig: The dollar value of all originations in the county, in thousands
- Note: these fields are present as an aggregate of all races and each race listed in the HMDA filings.


Running split_by_county.py will produce CSVs for each valid county that contain the following fields:
- FIXME add data fields

#### Method:
FIXME definition of method for calculated variables
To calculate a multiple of loan amount to income, loan amounts were taken from conventional products and multiplied by 0.80.

#### Loan Products:
- When using HMDA LAR data is is often important to filter for specific loan products.
- This repository has functions that aggregate single-family homes that were purchased or refinanced (loan purpose codes 1 and 3 respectively).

- To make this analysis more robust lien status should be added, but this variable does not exist until 2004.


#### Data Handling:
To handle Pandas dataframe issues, rows with income or amount values that contained NA or na were omitted.

Rows with incorrectly formatted data were removed from the HMDA LAR SQL tables. This removed between 15 and 30 rows per year (predominantly from agency code 7).



#### Notes:
Income Multiple - average loan amount has been divided by 0.80. All loans in the analysis were conventional loans.



